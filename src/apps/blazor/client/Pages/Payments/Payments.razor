@page "/payments"

<PageHeader Title="Payments" Header="Payments" SubHeader="Manage payment transactions" />

<MudStack Row="true" Spacing="2" Class="mb-4">
    <MudButton Variant="Variant.Filled" 
               Color="Color.Primary" 
               StartIcon="@Icons.Material.Filled.Upload"
               OnClick="OpenImportDialog">
        Import from Excel/CSV
    </MudButton>
    <MudButton Variant="Variant.Filled" 
               Color="Color.Secondary" 
               StartIcon="@Icons.Material.Filled.Download"
               OnClick="ExportPayments">
        Export to Excel
    </MudButton>
</MudStack>

<EntityTable @ref="_table" TEntity="PaymentResponse" TId="Guid" TRequest="PaymentViewModel" Context="@Context">
<AdvancedSearchContent>
    <!-- Advanced search filters are handled in the searchFunc in code-behind -->
</AdvancedSearchContent>

<EditFormContent>
        @if (!Context.AddEditModal.IsCreate)
        {
            <MudItem xs="12" md="6">
                <MudTextField Value="@context.Id.ToString()" Underline="false" ReadOnly Label="Payment Id" />
            </MudItem>
        }
        <MudItem xs="12" md="6">
            <MudAutocomplete T="CustomerResponse" 
                            Label="Customer (Search by SSN or Name)" 
                            @bind-Value="_selectedCustomer"
                            SearchFunc="SearchCustomers"
                            ToStringFunc="@(c => c?.Ssn ?? string.Empty)"
                            ResetValueOnEmptyText="true"
                            CoerceText="true"
                            Required="true"
                            RequiredError="Customer is required"
                            HelperText="Enter customer SSN or name to search">
                <ItemTemplate Context="customer">
                    <MudText Typo="Typo.body2">@customer.Ssn - @customer.Name</MudText>
                </ItemTemplate>
            </MudAutocomplete>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudTextField Label="Invoice ID (Optional)" 
                         For="@(() => context.InvoiceId)" 
                         @bind-Value="context.InvoiceId" />
        </MudItem>
        <MudItem xs="12" md="6">
            <MudNumericField T="double?" 
                            Label="Amount" 
                            For="@(() => context.Amount)" 
                            @bind-Value="context.Amount"
                            Min="0.01"
                            Format="N2" />
        </MudItem>
        <MudItem xs="12" md="6">
            <MudTextField Label="Currency" 
                         For="@(() => context.Currency)" 
                         @bind-Value="context.Currency"
                         MaxLength="3" />
        </MudItem>
        <MudItem xs="12" md="6">
            <MudSelect T="PaymentMethod" 
                      Label="Payment Method" 
                      @bind-Value="context.Method"
                      For="@(() => context.Method)">
                @foreach (PaymentMethod method in Enum.GetValues(typeof(PaymentMethod)))
                {
                    <MudSelectItem T="PaymentMethod" Value="@method">@method.ToString()</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        @if (!Context.AddEditModal.IsCreate)
        {
            <MudItem xs="12" md="6">
                <MudSelect T="PaymentStatus" 
                          Label="Status" 
                          @bind-Value="context.Status"
                          Disabled="true">
                    @foreach (PaymentStatus status in Enum.GetValues(typeof(PaymentStatus)))
                    {
                        <MudSelectItem T="PaymentStatus" Value="@status">@status.ToString()</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudTextField Label="Transaction ID" 
                             Value="@context.TransactionId" 
                             ReadOnly 
                             Underline="false" />
            </MudItem>
        }
        <MudItem xs="12">
            <MudTextField Label="Description" 
                         For="@(() => context.Description)" 
                         @bind-Value="context.Description"
                         Lines="3" />
        </MudItem>
        @if (!Context.AddEditModal.IsCreate && !string.IsNullOrEmpty(context.FailureReason))
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Error">@context.FailureReason</MudAlert>
            </MudItem>
        }
    </EditFormContent>

</EntityTable>
